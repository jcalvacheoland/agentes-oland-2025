trigger:
- master

pool:
  vmImage: ubuntu-latest

variables:
  node_version: '22.x'
  app_name: 'agentes-oland-2025'
  azure_connection: 'agentes-oland-2025'   # tu service connection

steps:
- task: NodeTool@0
  inputs:
    versionSpec: '$(node_version)'
  displayName: 'Install Node.js'

- script: |
    npm ci
  displayName: 'Install dependencies'

# Build (con env del pipeline; aseg√∫rate de declarar las variables en Pipeline UI)
- script: |
    echo "Building with BITRIX_DOMAIN=$(BITRIX_DOMAIN)"
    npm run build
  displayName: 'Build Next.js app'
  env:
    BITRIX_DOMAIN: $(BITRIX_DOMAIN)
    BITRIX_CLIENT_ID: $(BITRIX_CLIENT_ID)
    BITRIX_CLIENT_SECRET: $(BITRIX_CLIENT_SECRET)

# Package
- task: ArchiveFiles@2
  inputs:
    rootFolderOrFile: '.'
    includeRootFolder: false
    archiveType: 'zip'
    archiveFile: '$(Build.ArtifactStagingDirectory)/app.zip'
    replaceExistingArchive: true
  displayName: 'Package app for deployment'

# Deploy to App Service (Linux)
- task: AzureWebApp@1
  inputs:
    azureSubscription: '$(azure_connection)'
    appName: '$(app_name)'
    package: '$(Build.ArtifactStagingDirectory)/app.zip'
  displayName: 'Deploy to App Service'
